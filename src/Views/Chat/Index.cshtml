@{
    ViewData["Title"] = "Chat with AI";
}

<div class="row">
    <div class="col-md-8 mx-auto">
        <h1 class="mb-4">@ViewData["Title"]</h1>
        <p class="text-muted">Ask me anything! Powered by Microsoft Foundry Phi-4</p>

        <div class="card">
            <div class="card-body">
                <div id="chatHistory" class="mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
                    <div class="text-muted text-center">Start a conversation...</div>
                </div>

                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Type your message here..." autocomplete="off">
                    <button class="btn btn-primary" type="button" id="sendButton">
                        <i class="bi bi-send"></i> Send
                    </button>
                </div>

                <div id="loadingIndicator" class="text-center mt-2" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2 text-muted">AI is thinking...</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const chatHistory = $('#chatHistory');
            const messageInput = $('#messageInput');
            const sendButton = $('#sendButton');
            const loadingIndicator = $('#loadingIndicator');

            function addMessage(role, content) {
                const messageClass = role === 'user' ? 'bg-primary text-white' : 'bg-light';
                const alignment = role === 'user' ? 'text-end' : 'text-start';
                const messageDiv = $('<div>')
                    .addClass(`mb-3 ${alignment}`)
                    .html(`
                        <div class="d-inline-block ${messageClass} p-2 rounded" style="max-width: 80%;">
                            <strong>${role === 'user' ? 'You' : 'AI Assistant'}:</strong><br>
                            ${content.replace(/\n/g, '<br>')}
                        </div>
                    `);

                if (chatHistory.children().first().hasClass('text-muted')) {
                    chatHistory.empty();
                }

                chatHistory.append(messageDiv);
                chatHistory.scrollTop(chatHistory[0].scrollHeight);
            }

            function sendMessage() {
                const message = messageInput.val().trim();
                if (!message) return;

                addMessage('user', message);
                messageInput.val('');
                sendButton.prop('disabled', true);
                loadingIndicator.show();

                $.ajax({
                    url: '@Url.Action("SendMessage", "Chat")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content: message }),
                    success: function(data) {
                        addMessage('assistant', data.response);
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || 'An error occurred. Please try again.';
                        addMessage('assistant', 'Error: ' + errorMsg);
                    },
                    complete: function() {
                        sendButton.prop('disabled', false);
                        loadingIndicator.hide();
                        messageInput.focus();
                    }
                });
            }

            sendButton.click(sendMessage);

            messageInput.keypress(function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.focus();
        });
    </script>
}
